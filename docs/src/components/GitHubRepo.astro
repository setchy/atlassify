---
import { Icon } from 'astro-icon/components';
import { siteMetadata, URLs } from '~/constants';
import type { LatestRelease, Repository, RepoStats } from '~/types';

const loadRepoStats = async (): Promise<RepoStats> => {
  try {
    const response = await fetch(URLs.API.REPO);
    const repository: Repository = await response.json();

    const res = await fetch(URLs.API.LATEST_RELEASE);
    const latestRelease: LatestRelease = await res.json();

    return {
      stargazersCount: repository.stargazers_count,
      forksCount: repository.forks_count,
      latestReleaseName: latestRelease.name,
    };
  } catch (error) {
    console.error('Failed to load repo stats', error);
    return {
      stargazersCount: 0,
      forksCount: 0,
      latestReleaseName: '',
    };
  }
};

const { forksCount, stargazersCount, latestReleaseName } =
  await loadRepoStats();
---

<a href={URLs.HTML.REPO} 
    target="_blank"
    rel="noopener noreferrer"
    aria-label="GitHub Repository"
    class="text-white hover:text-blue-300 hover:no-underline"


>
  <section
    class="flex flex-row gap-2"
  >
    <Icon name="mdi:github" size={32}  />
    <div class="font-light">
      <div class="text-sm">{siteMetadata.repo}</div>
      <div class="flex flex-row gap-2 text-xs">
        <div class="flex flex-row gap-0.5 items-center">
          <Icon name="mdi:tag-outline" />
          {latestReleaseName}
        </div>
        <div class="flex flex-1 gap-0.5 items-center"><Icon name="mdi:star-outline" /> {stargazersCount}</div>
        <div class="flex flex-1 gap-0.5 items-center"><Icon name="mdi:source-branch" /> {forksCount}</div>
      </div>
    </div>
  </section>
</a>